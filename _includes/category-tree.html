{% comment %}
Build a hierarchical category tree from all posts
{% endcomment %}

{% assign all_categories = "" | split: "" %}
{% for post in site.posts %}
  {% for category in post.categories %}
    {% unless all_categories contains category %}
      {% assign all_categories = all_categories | push: category %}
    {% endunless %}
  {% endfor %}
{% endfor %}

{% comment %}
Group posts by their first category (top level)
{% endcomment %}
{% assign top_categories = "" | split: "" %}
{% for post in site.posts %}
  {% if post.categories.size > 0 %}
    {% assign top_cat = post.categories[0] %}
    {% unless top_categories contains top_cat %}
      {% assign top_categories = top_categories | push: top_cat %}
    {% endunless %}
  {% endif %}
{% endfor %}

<div class="category-tree">
  {% for top_cat in top_categories %}
    <div class="category-section" style="margin-bottom: 30px;">
      <h3 style="color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        üìÅ {{ top_cat }}
      </h3>
      
      {% comment %}Find all posts in this top category{% endcomment %}
      {% assign top_posts = site.posts | where_exp: "post", "post.categories[0] == top_cat" %}
      
      {% comment %}Group by second level category{% endcomment %}
      {% assign second_cats = "" | split: "" %}
      {% for post in top_posts %}
        {% if post.categories.size > 1 %}
          {% assign second_cat = post.categories[1] %}
          {% unless second_cats contains second_cat %}
            {% assign second_cats = second_cats | push: second_cat %}
          {% endunless %}
        {% endif %}
      {% endfor %}
      
      {% if second_cats.size > 0 %}
        {% for second_cat in second_cats %}
          <div style="margin-left: 20px; margin-top: 15px;">
            <h4 style="color: #555; font-size: 1.1em;">üìÇ {{ second_cat }}</h4>
            
            {% assign second_posts = top_posts | where_exp: "post", "post.categories[1] == second_cat" %}
            
            {% comment %}Group by third level{% endcomment %}
            {% assign third_cats = "" | split: "" %}
            {% for post in second_posts %}
              {% if post.categories.size > 2 %}
                {% assign third_cat = post.categories[2] %}
                {% unless third_cats contains third_cat %}
                  {% assign third_cats = third_cats | push: third_cat %}
                {% endunless %}
              {% endif %}
            {% endfor %}
            
            {% if third_cats.size > 0 %}
              {% for third_cat in third_cats %}
                <div style="margin-left: 20px; margin-top: 10px;">
                  <h5 style="color: #666; font-size: 1em;">üìÇ {{ third_cat }}</h5>
                  <ul style="list-style: none; padding-left: 20px; margin-top: 5px;">
                    {% assign third_posts = second_posts | where_exp: "post", "post.categories[2] == third_cat" %}
                    {% for post in third_posts %}
                      <li style="margin-bottom: 8px;">
                        <a href="{{ post.url | relative_url }}" style="color: #0066cc; text-decoration: none;">
                          üìÑ {{ post.title }}
                        </a>
                        <span style="color: #999; font-size: 0.85em; margin-left: 8px;">
                          {{ post.date | date: "%b %-d, %Y" }}
                        </span>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            {% else %}
              <ul style="list-style: none; padding-left: 20px; margin-top: 5px;">
                {% for post in second_posts %}
                  {% if post.categories.size == 2 %}
                    <li style="margin-bottom: 8px;">
                      <a href="{{ post.url | relative_url }}" style="color: #0066cc; text-decoration: none;">
                        üìÑ {{ post.title }}
                      </a>
                      <span style="color: #999; font-size: 0.85em; margin-left: 8px;">
                        {{ post.date | date: "%b %-d, %Y" }}
                      </span>
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <ul style="list-style: none; padding-left: 20px; margin-top: 5px;">
          {% for post in top_posts %}
            {% if post.categories.size == 1 %}
              <li style="margin-bottom: 8px;">
                <a href="{{ post.url | relative_url }}" style="color: #0066cc; text-decoration: none;">
                  üìÑ {{ post.title }}
                </a>
                <span style="color: #999; font-size: 0.85em; margin-left: 8px;">
                  {{ post.date | date: "%b %-d, %Y" }}
                </span>
              </li>
            {% endif %}
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  {% endfor %}
</div>
